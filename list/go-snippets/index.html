

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>go snippets | 存档Save&amp;Load</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="有用的 go 语言代码片段收集。
特别是不常见，或者常见但容易出错的。
尽量

实际运行验证过
标注验证的 go 版本和相关的环境
标注使用要点

接口实现的静态类型检查go struct 实现 interface 不需要显式的声明，只需要实现其所有方法签名。
这实际上是一种 duck typing（鸭子类型，『当看到一只鸟走起来像鸭子、游泳起来像鸭子、叫起来也像鸭子，那么这只鸟就可以被称为鸭子。">
<meta property="og:type" content="website">
<meta property="og:title" content="go snippets">
<meta property="og:url" content="https://jaycechant.info/list/go-snippets/index.html">
<meta property="og:site_name" content="存档Save&Load">
<meta property="og:description" content="有用的 go 语言代码片段收集。
特别是不常见，或者常见但容易出错的。
尽量

实际运行验证过
标注验证的 go 版本和相关的环境
标注使用要点

接口实现的静态类型检查go struct 实现 interface 不需要显式的声明，只需要实现其所有方法签名。
这实际上是一种 duck typing（鸭子类型，『当看到一只鸟走起来像鸭子、游泳起来像鸭子、叫起来也像鸭子，那么这只鸟就可以被称为鸭子。">
<meta property="og:image" content="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png">
<meta property="og:updated_time" content="2020-03-03T13:22:19.661Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="go snippets">
<meta name="twitter:description" content="有用的 go 语言代码片段收集。
特别是不常见，或者常见但容易出错的。
尽量

实际运行验证过
标注验证的 go 版本和相关的环境
标注使用要点

接口实现的静态类型检查go struct 实现 interface 不需要显式的声明，只需要实现其所有方法签名。
这实际上是一种 duck typing（鸭子类型，『当看到一只鸟走起来像鸭子、游泳起来像鸭子、叫起来也像鸭子，那么这只鸟就可以被称为鸭子。">
<meta name="twitter:image" content="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png">
  
    <link rel="alternative" href="/atom.xml" title="存档Save&amp;Load" type="application/atom+xml">
  
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">存档Save&amp;Load</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">存档意味着放下包袱，搞砸了不过回来读档</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/list">List</a>
        
          <a class="main-nav-link" href="https://github.com/JayceChant">Github</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/sitemap.xml">Sitemap</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <!--<div id="search-form-wrap">
        <form action="https://global.bing.com/search" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="q" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name="si" type="hidden" value="jaycechant.info">
          <input name="ensearch" type="hidden" value="1">
        </form>
      </div>-->
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="page-undefined" class="article article-type-page" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/list/go-snippets/index.html" class="article-date">
  <time datetime="2020-02-29T03:28:15.000Z" itemprop="datePublished">2020-02-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      go snippets
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>有用的 go 语言代码片段收集。</p>
<p>特别是不常见，或者常见但容易出错的。</p>
<p>尽量</p>
<ul>
<li>实际运行验证过</li>
<li>标注验证的 go 版本和相关的环境</li>
<li>标注使用要点</li>
</ul>
<h2 id="接口实现的静态类型检查"><a href="#接口实现的静态类型检查" class="headerlink" title="接口实现的静态类型检查"></a>接口实现的静态类型检查</h2><p>go struct 实现 interface 不需要显式的声明，只需要实现其所有方法签名。</p>
<p>这实际上是一种 duck typing（鸭子类型，『当看到一只鸟走起来像鸭子、游泳起来像鸭子、叫起来也像鸭子，那么这只鸟就可以被称为鸭子。』），而 go 很可能是唯一一个实现鸭子类型的静态语言。</p>
<p>鸭子类型关注行为而不是继承链，给灵活实现提供了便利。不过由于没有显式声明，如果在实现时出了差错，比较难发现（如打错方法签名，或者 go 特有的问题：方法 receiver 弄混了 值类型 和 指针类型）。所以需要加入静态检查，利用好静态语言的优势。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> (</div><div class="line">    <span class="comment">// 静态类型检查</span></div><div class="line">    _ Ducker = (*Duck)(<span class="literal">nil</span>)</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// 接口定义</span></div><div class="line"><span class="keyword">type</span> Ducker <span class="keyword">interface</span> &#123;</div><div class="line">    Quack() <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 类型定义</span></div><div class="line"><span class="keyword">type</span> Duck <span class="keyword">struct</span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 方法实现</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Duck)</span><span class="title">Quack</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"Gagaga!"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个类型转换将空值转为 Duck 指针，然后赋值给 Ducker 类型，最后丢弃。这一行最后会被编译器优化掉（因为没有任何实际意义），不会有任何实际开销，但是在静态检查中如果类型不对，还是会报错。</p>
<h2 id="优雅关闭"><a href="#优雅关闭" class="headerlink" title="优雅关闭"></a>优雅关闭</h2><p>Graceful Shutdown 是指，在接收到退出信号时，不是马上退出，而是先停止接受新请求，然后把当前请求处理完，再主动退出。</p>
<p>这适合守护进程 daemon 型应用（典型的是服务器），实现一个循环持续接受请求并处理，处理完并不会退出而是等待接下来的请求，直到收到退出信号。</p>
<h3 id="单（主）-goroutine-版"><a href="#单（主）-goroutine-版" class="headerlink" title="单（主） goroutine 版"></a>单（主） goroutine 版</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// go 1.13</span></div><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">    <span class="string">"os/signal"</span></div><div class="line">    <span class="string">"syscall"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    loop()</div><div class="line">    <span class="comment">// 如果不是优雅退出，则无论如何执行不到这里</span></div><div class="line">    fmt.Println(<span class="string">"cleaning up"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">loop</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// 缓冲大小为 1 的信号通道，避免写阻塞</span></div><div class="line">    sigch := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</div><div class="line">    <span class="comment">// 注册接收信号</span></div><div class="line">    signal.Notify(sigch, syscall.SIGINT, syscall.SIGTERM)</div><div class="line">    <span class="keyword">for</span> &#123; <span class="comment">// 死循环直到 return</span></div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">        <span class="comment">// select 在不阻塞的 case 里随机选一个，都阻塞就走 default</span></div><div class="line">        <span class="keyword">case</span> &lt;-sigch:</div><div class="line">            <span class="comment">// 注意这里如果 break 只能跳出 select</span></div><div class="line">            <span class="comment">// 如果不用return，就要用 break LABEL 指定跳出的层次</span></div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="comment">// 在收到退出信号前，一直跑这个分支</span></div><div class="line">            fmt.Println(<span class="string">"do something"</span>)</div><div class="line">            time.Sleep(time.Second)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">do</span> something</div><div class="line"><span class="keyword">do</span> something</div><div class="line">...</div><div class="line">(Ctrl + C)</div><div class="line">cleaning up</div></pre></td></tr></table></figure>
<h3 id="独立工作-goroutine-版"><a href="#独立工作-goroutine-版" class="headerlink" title="独立工作 goroutine 版"></a>独立工作 goroutine 版</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">    <span class="string">"os/signal"</span></div><div class="line">    <span class="string">"syscall"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    sigch := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</div><div class="line">    signal.Notify(sigch, syscall.SIGINT, syscall.SIGTERM)</div><div class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> &lt;-sigch:</div><div class="line">                done &lt;- <span class="literal">true</span></div><div class="line">                <span class="keyword">return</span></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                fmt.Println(<span class="string">"do something"</span>)</div><div class="line">                time.Sleep(time.Second)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    </div><div class="line">    fmt.Println(<span class="string">"goroutine started."</span>)</div><div class="line"></div><div class="line">    <span class="comment">// 阻塞在这里等子协程，否则主协程结束退出，会连带结束子协程</span></div><div class="line">    <span class="comment">// 如果有多个子协程，可以用 WaitGroup</span></div><div class="line">    &lt;-done</div><div class="line">    </div><div class="line">    fmt.Println(<span class="string">"goroutine stoped. exit."</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">goroutine started.</div><div class="line"><span class="keyword">do</span> something</div><div class="line"><span class="keyword">do</span> something</div><div class="line">...</div><div class="line">(Ctrl + C)</div><div class="line">goroutine stoped. exit.</div></pre></td></tr></table></figure>
<h2 id="测试直接-os-Exit-的函数的-exit-code"><a href="#测试直接-os-Exit-的函数的-exit-code" class="headerlink" title="测试直接 os.Exit() 的函数的 exit code"></a>测试直接 os.Exit() 的函数的 exit code</h2><p>单元测试有助于提高软件组件质量，及早发现错误，减少后期发现和修复问题的负担。</p>
<p>go 在 工具链 和 原生库 级别就给单元测试提供了大量支持，只需要引入原生库就可以写成比较完善的测试。在此基础上再引入少量第三方库（如 testify）就可以写出非常优雅的测试。</p>
<p>这降低了写单元测试的负担，提高了大家写单元测试的积极性。如果使用 TDD 进行开发，用运行单元测试来保证每次修改的质量，能够极大地解放开发者的心智负担。</p>
<p>不过最近遇到了一种情况，在做重构时使用单元测试来确保没有破坏原有的功能。结果无论怎么改，测试都是通过。一开始还以为是确实没错。直到我发现了一个 bug，但是测试依然通过，我才反应过来被测函数里有 <code>os.Exit(int)</code> ，测试其实被提前退出了，根本没有测。而这种情况， <strong>go test 仍然算 passed</strong> 。</p>
<h3 id="子进程测试"><a href="#子进程测试" class="headerlink" title="子进程测试"></a>子进程测试</h3><p>怎么办呢？这个函数确实需要遇到错误提前退出。在参考 <a href="https://stackoverflow.com/questions/26225513/how-to-test-os-exit-scenarios-in-go" target="_blank" rel="external">stackoverflow</a> 之后，我发现了这种写法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// go 1.13</span></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"os"</span></div><div class="line">    <span class="string">"os/exec"</span></div><div class="line">    <span class="string">"runtime"</span></div><div class="line">    <span class="string">"testing"</span></div><div class="line"></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestFoo</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> os.Getenv(<span class="string">"TEST_RUNNER"</span>) == <span class="string">"1"</span> &#123;</div><div class="line">        <span class="comment">// 如果是子进程，直接调用要测试的函数</span></div><div class="line">        <span class="comment">//（只要你选用的环境变量没有跟已有的环境变量撞名字，第一次进来一定不会运行这里）</span></div><div class="line">        Foo(<span class="string">"some args"</span>, <span class="number">1</span>, <span class="literal">false</span>) <span class="comment">// Foo() 里面有调用 os.Exit(int)</span></div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 如果不是子进程，创建一个子进程只执行当前测试，并且通过环境变量 TEST_RUNNER 标记为子进程</span></div><div class="line">    <span class="comment">// 然后根据子进程的返回值判断测试结果</span></div><div class="line">    cmd := exec.Command(os.Args[<span class="number">0</span>], <span class="string">"-test.run=^(TestFoo)$"</span>) <span class="comment">// 避免函数名部分重复，加上行首和行尾限定</span></div><div class="line">    cmd.Env = <span class="built_in">append</span>(os.Environ(), <span class="string">"TEST_RUNNER=1"</span>)</div><div class="line">    err := cmd.Run()</div><div class="line">    e, ok := err.(*exec.ExitError)</div><div class="line"></div><div class="line">    <span class="comment">// 这里假定 exit 为 0 是正常</span></div><div class="line">    <span class="keyword">if</span> ok &amp;&amp; e.ExitCode() != <span class="number">0</span> &#123;</div><div class="line">        t.Errorf(<span class="string">"exit code got %d, expected 0"</span>, e.ExitCode())</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="子进程测试的工具函数"><a href="#子进程测试的工具函数" class="headerlink" title="子进程测试的工具函数"></a>子进程测试的工具函数</h3><p>不过每个测试函数都这样写，太累，还容易出错。能不能写成通用的函数呢？可以。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">assertExitCode</span><span class="params">(t *testing.T, f <span class="keyword">func</span>()</span>, <span class="title">expected</span> <span class="title">int</span>)</span> &#123;</div><div class="line">    <span class="keyword">if</span> os.Getenv(<span class="string">"TEST_RUNNER"</span>) == <span class="string">"1"</span> &#123;</div><div class="line">        <span class="comment">// 待测试函数作为参数传进来然后在子进程执行</span></div><div class="line">        f()</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 获取单元测试函数名</span></div><div class="line">    pc := <span class="built_in">make</span>([]<span class="keyword">uintptr</span>, <span class="number">1</span>)</div><div class="line">    <span class="comment">// 读取调用栈的第三帧（跳过两帧，第一帧是 Callers 函数自身）</span></div><div class="line">    runtime.Callers(<span class="number">2</span>, pc)</div><div class="line">    ft := runtime.FuncForPC(pc[<span class="number">0</span>])</div><div class="line">    nn := strings.Split(ft.Name(), <span class="string">"."</span>)</div><div class="line"></div><div class="line">    cmd := exec.Command(os.Args[<span class="number">0</span>], <span class="string">"-test.run=^("</span>+nn[<span class="built_in">len</span>(nn)<span class="number">-1</span>]+<span class="string">")$"</span>)</div><div class="line">    cmd.Env = <span class="built_in">append</span>(os.Environ(), <span class="string">"TEST_RUNNER=1"</span>)</div><div class="line">    err := cmd.Run()</div><div class="line">    e, ok := err.(*exec.ExitError)</div><div class="line"></div><div class="line">    <span class="comment">// 预期 exit = 0</span></div><div class="line">    <span class="keyword">if</span> expected == <span class="number">0</span> &#123;</div><div class="line">        <span class="keyword">if</span> ok &amp;&amp; e.ExitCode() != <span class="number">0</span> &#123;</div><div class="line">            t.Errorf(<span class="string">"exit code got %d, expected %d"</span>, e.ExitCode(), <span class="number">0</span>)</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 预期 exit 非 0 的分两种情况</span></div><div class="line">    <span class="comment">// 1. 返回的 error 不是 ExitError，一般是 nil 说明 exit 0，或者是别的 error</span></div><div class="line">    <span class="keyword">if</span> !ok &#123;</div><div class="line">        t.Errorf(<span class="string">"expect ExitError with code %d, got err %v"</span>, expected, err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 2. 返回的是 ExitError，但是 code 不对</span></div><div class="line">    <span class="keyword">if</span> e.ExitCode() != expected &#123;</div><div class="line">        t.Errorf(<span class="string">"exit code got %d, expected %d"</span>, e.ExitCode(), expected)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestFoo</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    assertExitCode(t, <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        Foo(<span class="string">"some args"</span>, <span class="number">1</span>, <span class="literal">false</span>)</div><div class="line">    &#125;, <span class="number">0</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="支持测试多个-次-os-Exit-的工具函数"><a href="#支持测试多个-次-os-Exit-的工具函数" class="headerlink" title="支持测试多个/次 os.Exit() 的工具函数"></a>支持测试多个/次 os.Exit() 的工具函数</h3><p>不过以上两种写法，都有一个 <strong>副作用</strong> ：一个单元测试里只能测试一次带有 <code>os.Exit(int)</code> 的函数。调用两次或以上的话，实际上只会测试到第一次，然后就退出了。这就只能每个测试分开测试函数写。</p>
<p>当然，额外增加一些参数，还是可以让子进程之间区分开的，但这样代码和心智的负担都增加了，还不如分开写测试。除非是表格驱动测试，测试用例量很大，那只好再改进一下了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">assertExitCode</span><span class="params">(t *testing.T, f <span class="keyword">func</span>()</span>, <span class="title">flag</span> <span class="title">string</span>, <span class="title">expected</span> <span class="title">int</span>)</span> &#123;</div><div class="line">    <span class="keyword">if</span> env := os.Getenv(<span class="string">"TEST_RUNNER"</span>); env != <span class="string">""</span> &#123;</div><div class="line">        <span class="comment">// 只要环境变量非空（说明已经是子进程）就不再创建子进程</span></div><div class="line">        <span class="comment">// 但只有 flag 一致，才实际执行</span></div><div class="line">        <span class="keyword">if</span> env == flag &#123;</div><div class="line">            f()</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 获取单元测试函数名</span></div><div class="line">    pc := <span class="built_in">make</span>([]<span class="keyword">uintptr</span>, <span class="number">1</span>)</div><div class="line">    <span class="comment">// 读取调用栈的第三帧（跳过两帧，第一帧是 Callers 函数自身）</span></div><div class="line">    runtime.Callers(<span class="number">2</span>, pc)</div><div class="line">    ft := runtime.FuncForPC(pc[<span class="number">0</span>])</div><div class="line">    nn := strings.Split(ft.Name(), <span class="string">"."</span>)</div><div class="line"></div><div class="line">    cmd := exec.Command(os.Args[<span class="number">0</span>], <span class="string">"-test.run=^("</span>+nn[<span class="built_in">len</span>(nn)<span class="number">-1</span>]+<span class="string">")$"</span>)</div><div class="line">    cmd.Env = <span class="built_in">append</span>(os.Environ(), <span class="string">"TEST_RUNNER="</span>+flag)</div><div class="line">    err := cmd.Run()</div><div class="line">    e, ok := err.(*exec.ExitError)</div><div class="line"></div><div class="line">    <span class="comment">// 预期 exit = 0</span></div><div class="line">    <span class="keyword">if</span> expected == <span class="number">0</span> &#123;</div><div class="line">        <span class="keyword">if</span> ok &amp;&amp; e.ExitCode() != <span class="number">0</span> &#123;</div><div class="line">            t.Errorf(<span class="string">"exit code got %d, expected %d"</span>, e.ExitCode(), <span class="number">0</span>)</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 预期 exit 非 0 的分两种情况</span></div><div class="line">    <span class="comment">// 1. 返回的 error 不是 ExitError，一般是 nil 说明 exit 0，或者是别的 error</span></div><div class="line">    <span class="keyword">if</span> !ok &#123;</div><div class="line">        t.Errorf(<span class="string">"expect ExitError with code %d, got err %v"</span>, expected, err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 2. 返回的是 ExitError，但是 code 不对</span></div><div class="line">    <span class="keyword">if</span> e.ExitCode() != expected &#123;</div><div class="line">        t.Errorf(<span class="string">"exit code got %d, expected %d"</span>, e.ExitCode(), expected)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestFooBar</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    assertExitCode(t, <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        Foo(<span class="string">"some args"</span>, <span class="number">1</span>, <span class="literal">false</span>)</div><div class="line">    &#125;, <span class="string">"foo"</span>, <span class="number">0</span>)</div><div class="line"></div><div class="line">    assertExitCode(t, <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        Bar(<span class="string">"some args"</span>, <span class="number">2</span>)</div><div class="line">    &#125;, <span class="string">"bar"</span>, <span class="number">0</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对了，以上三种写法 <strong>还有一个副作用</strong> ：因为测试不是在当前进程里做的，凡是用这种方法测试的，都不计算覆盖率。</p>
<hr>
<p><img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="知识共享 “署名-非商业性使用-相同方式共享” 4.0 (CC BY-NC-SA 4.0)”许可协议"><br>本文为本人原创，采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="external">知识共享 “署名-非商业性使用-相同方式共享” 4.0 (CC BY-NC-SA 4.0)”许可协议</a>进行许可。<br>本作品可自由复制、传播及基于本作品进行演绎创作。如有以上需要，请留言告知，在文章开头明显位置加上署名（Jayce Chant）、原链接及许可协议信息，并明确指出修改（如有），不得用于商业用途。谢谢合作。<br>请点击查看<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="external">协议</a>的中文摘要。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://jaycechant.info/list/go-snippets/index.html" data-id="ck8n1umwr00972oxly74gtwqz" class="article-share-link" data-share="baidu">分享到</a>
      

      
        <a href="https://jaycechant.info/list/go-snippets/index.html#disqus_thread" class="article-comment-link">评论</a>
      

      
    </footer>
  </div>
  
    
  
</article>


  <section id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Anaconda/" style="font-size: 10px;">Anaconda</a> <a href="/tags/Android/" style="font-size: 11.67px;">Android</a> <a href="/tags/Android-sdk/" style="font-size: 10px;">Android-sdk</a> <a href="/tags/CentOS/" style="font-size: 10px;">CentOS</a> <a href="/tags/JCE/" style="font-size: 10px;">JCE</a> <a href="/tags/Java/" style="font-size: 11.67px;">Java</a> <a href="/tags/JavaMail/" style="font-size: 10px;">JavaMail</a> <a href="/tags/Jenkins/" style="font-size: 16.67px;">Jenkins</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Markdown/" style="font-size: 13.33px;">Markdown</a> <a href="/tags/Mathjax/" style="font-size: 10px;">Mathjax</a> <a href="/tags/OJ/" style="font-size: 10px;">OJ</a> <a href="/tags/Octopress/" style="font-size: 10px;">Octopress</a> <a href="/tags/OpenGrok/" style="font-size: 10px;">OpenGrok</a> <a href="/tags/Python/" style="font-size: 16.67px;">Python</a> <a href="/tags/Ruby/" style="font-size: 10px;">Ruby</a> <a href="/tags/Syncthing/" style="font-size: 10px;">Syncthing</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/Ubuntu/" style="font-size: 11.67px;">Ubuntu</a> <a href="/tags/algorithm/" style="font-size: 11.67px;">algorithm</a> <a href="/tags/aliyun/" style="font-size: 10px;">aliyun</a> <a href="/tags/app/" style="font-size: 10px;">app</a> <a href="/tags/blog/" style="font-size: 13.33px;">blog</a> <a href="/tags/byobu/" style="font-size: 11.67px;">byobu</a> <a href="/tags/ctags/" style="font-size: 10px;">ctags</a> <a href="/tags/dep/" style="font-size: 11.67px;">dep</a> <a href="/tags/document/" style="font-size: 10px;">document</a> <a href="/tags/dropbox/" style="font-size: 10px;">dropbox</a> <a href="/tags/file-system/" style="font-size: 10px;">file-system</a> <a href="/tags/flutter/" style="font-size: 10px;">flutter</a> <a href="/tags/git/" style="font-size: 11.67px;">git</a> <a href="/tags/glide/" style="font-size: 10px;">glide</a> <a href="/tags/golang/" style="font-size: 20px;">golang</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/how-to/" style="font-size: 16.67px;">how-to</a> <a href="/tags/jpg/" style="font-size: 10px;">jpg</a> <a href="/tags/json/" style="font-size: 11.67px;">json</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/mirror/" style="font-size: 10px;">mirror</a> <a href="/tags/netdisk/" style="font-size: 10px;">netdisk</a> <a href="/tags/node-js/" style="font-size: 11.67px;">node.js</a> <a href="/tags/nodePPT/" style="font-size: 11.67px;">nodePPT</a> <a href="/tags/npm/" style="font-size: 10px;">npm</a> <a href="/tags/pgyer/" style="font-size: 10px;">pgyer</a> <a href="/tags/pip/" style="font-size: 15px;">pip</a> <a href="/tags/png/" style="font-size: 10px;">png</a> <a href="/tags/practice/" style="font-size: 11.67px;">practice</a> <a href="/tags/presentation/" style="font-size: 11.67px;">presentation</a> <a href="/tags/screen/" style="font-size: 11.67px;">screen</a> <a href="/tags/service/" style="font-size: 10px;">service</a> <a href="/tags/skill/" style="font-size: 13.33px;">skill</a> <a href="/tags/smtp/" style="font-size: 10px;">smtp</a> <a href="/tags/software/" style="font-size: 10px;">software</a> <a href="/tags/solution-report/" style="font-size: 10px;">solution-report</a> <a href="/tags/supervisor/" style="font-size: 10px;">supervisor</a> <a href="/tags/trouble/" style="font-size: 18.33px;">trouble</a> <a href="/tags/unfinished/" style="font-size: 13.33px;">unfinished</a> <a href="/tags/virtualenv/" style="font-size: 10px;">virtualenv</a> <a href="/tags/vsftp/" style="font-size: 10px;">vsftp</a> <a href="/tags/why/" style="font-size: 11.67px;">why</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">四月 2012</a><span class="archive-list-count">5</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/go-bindata-golang-static-resources-embedding/">go-bindata：go 语言的静态资源嵌入</a>
          </li>
        
          <li>
            <a href="/2020/progressive-image-loading/">渐进式图像加载</a>
          </li>
        
          <li>
            <a href="/2020/should-i-learn-programming/">我该学编程吗？</a>
          </li>
        
          <li>
            <a href="/2020/flutter-kickoff/">Flutter 踩坑流水账</a>
          </li>
        
          <li>
            <a href="/2020/golang-1-13-env-for-win/">配置 1.13+ 的 golang 环境（Windows 篇）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="https://hexo.io/zh-cn/" target="_blank">Hexo主页</a>
          </li>
        
          <li>
            <a href="https://hexo.io/zh-cn/docs/" target="_blank">Hexo文档</a>
          </li>
        
          <li>
            <a href="https://github.com/xiangming/landscape-plus" target="_blank">landscape-plus项目主页</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Jayce Sigit Chant<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/list" class="mobile-nav-link">List</a>
  
    <a href="https://github.com/JayceChant" class="mobile-nav-link">Github</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
    <a href="/sitemap.xml" class="mobile-nav-link">Sitemap</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="返回顶部"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<script>
  var disqus_shortname = 'jaycetb';
  
  var disqus_url = 'https://jaycechant.info/list/go-snippets/index.html';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>window._bd_share_config={"common":{},"share":{"bdCustomStyle":"/css/bdshare.css"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
                processEscapes: true
                    
}
  
        });
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
                  
}
    
        });
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Queue(function() {
            var all = MathJax.Hub.getAllJax(), i;
            for(i=0; i < all.length; i += 1) {
                            all[i].SourceElement().parentNode.className += ' has-jax';
                                    
            }
                
        });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<script src="/js/script.js"></script>

</div>
</body>
</html>

