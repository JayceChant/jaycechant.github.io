
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>LeetCode 题解： Regular Expression Matching | 存档Save&amp;Load</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一点点找回手感，容我继续水小题号的 Hard。">
<meta property="og:type" content="article">
<meta property="og:title" content="LeetCode 题解： Regular Expression Matching">
<meta property="og:url" content="https://jaycechant.info/2020/leetcode-10-regular-expression-matching/index.html">
<meta property="og:site_name" content="存档Save&Load">
<meta property="og:description" content="一点点找回手感，容我继续水小题号的 Hard。">
<meta property="og:image" content="https://jaycechant.info/../../images/leetcode10-sample1.svg">
<meta property="og:image" content="https://jaycechant.info/../../images/leetcode10-sample2.svg">
<meta property="og:image" content="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png">
<meta property="og:updated_time" content="2020-06-09T07:00:20.883Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LeetCode 题解： Regular Expression Matching">
<meta name="twitter:description" content="一点点找回手感，容我继续水小题号的 Hard。">
<meta name="twitter:image" content="https://jaycechant.info/../../images/leetcode10-sample1.svg">
  
    <link rel="alternative" href="/atom.xml" title="存档Save&amp;Load" type="application/atom+xml">
  
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">存档Save&amp;Load</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">存档意味着放下包袱，搞砸了不过回来读档</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/list">List</a>
        
          <a class="main-nav-link" href="https://github.com/JayceChant">Github</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/sitemap.xml">Sitemap</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
        
      </nav>
      
      <div id="search-form-wrap">
        <form action="" accept-charset="utf-8" class="search-form">
          <input id="searchtext" type="search" name="q" maxlength="20" class="search-form-input" placeholder="Search" onkeypress="if(event.keyCode==13){document.getElementById('searchsub').click();return false;}">
          <input id="searchsub" type="submit" value="" class="search-form-submit" onclick="window.open('https://global.bing.com/search?&amp;q=site:jaycechant.info '+document.getElementById('searchtext').value, '_blank')">
        </form>
      </div>
      
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="post-leetcode-10-regular-expression-matching" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/leetcode-10-regular-expression-matching/" class="article-date">
  <time datetime="2020-06-04T03:03:24.000Z" itemprop="datePublished">2020-06-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/刷题/">刷题</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      LeetCode 题解： Regular Expression Matching
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一点点找回手感，容我继续水小题号的 Hard。</p>
<a id="more"></a>
<p>这次做的是 10 号题：正则表达式匹配。</p>
<p>英文：<a href="https://leetcode.com/problems/regular-expression-matching/" target="_blank" rel="external">https://leetcode.com/problems/regular-expression-matching/</a></p>
<p>中文：<a href="https://leetcode-cn.com/problems/regular-expression-matching/" target="_blank" rel="external">https://leetcode-cn.com/problems/regular-expression-matching/</a></p>
<h2 id="理解题意"><a href="#理解题意" class="headerlink" title="理解题意"></a>理解题意</h2><h3 id="一句话题意"><a href="#一句话题意" class="headerlink" title="一句话题意"></a>一句话题意</h3><p>实现一个只有 <code>.</code> 和 <code>*</code> 的正则表达式子集，对给定的 字符串 <code>s</code> 和 模式串 <code>p</code> ，返回是否 <strong>全文匹配</strong> 。</p>
<blockquote>
<p><code>.</code> 匹配任意单个字符</p>
<p><code>*</code> 匹配零个或多个前一个元素</p>
</blockquote>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>见测试用例</p>
<h3 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h3><ul>
<li><code>s</code> 可能为空，且只包含从 <code>a-z</code> 的小写字母。</li>
<li><code>p</code> 可能为空，且只包含从 <code>a-z</code> 的小写字母，以及字符 <code>.</code> 和 <code>*</code>。</li>
</ul>
<h2 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h2><p>每篇题解，都会强调 <strong>准备纸笔</strong> 和 <strong>单元测试</strong> 。为此在做这道题时，还顺便写了 《<a href="../rapidly-generate-unit-tests-in-vs-code/">如何快速生成单元测试</a>》。</p>
<p>不多解释，直接贴代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"testing"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> tests = []<span class="keyword">struct</span> &#123;</div><div class="line">	name <span class="keyword">string</span></div><div class="line">	s    <span class="keyword">string</span></div><div class="line">	p    <span class="keyword">string</span></div><div class="line">	want <span class="keyword">bool</span></div><div class="line">&#125;&#123;</div><div class="line">	&#123;</div><div class="line">		name: <span class="string">"1"</span>,</div><div class="line">		s:    <span class="string">"aa"</span>,</div><div class="line">		p:    <span class="string">"a"</span>,</div><div class="line">		want: <span class="literal">false</span>,</div><div class="line">	&#125;,</div><div class="line">	&#123;</div><div class="line">		name: <span class="string">"2"</span>,</div><div class="line">		s:    <span class="string">"aa"</span>,</div><div class="line">		p:    <span class="string">"a*"</span>,</div><div class="line">		want: <span class="literal">true</span>,</div><div class="line">	&#125;,</div><div class="line">	&#123;</div><div class="line">		name: <span class="string">"3"</span>,</div><div class="line">		s:    <span class="string">"ab"</span>,</div><div class="line">		p:    <span class="string">".*"</span>,</div><div class="line">		want: <span class="literal">true</span>,</div><div class="line">	&#125;,</div><div class="line">	&#123;</div><div class="line">		name: <span class="string">"4"</span>,</div><div class="line">		s:    <span class="string">"aab"</span>,</div><div class="line">		p:    <span class="string">"c*a*b"</span>,</div><div class="line">		want: <span class="literal">true</span>,</div><div class="line">	&#125;,</div><div class="line">	&#123;</div><div class="line">		name: <span class="string">"5"</span>,</div><div class="line">		s:    <span class="string">"mississippi"</span>,</div><div class="line">		p:    <span class="string">"mis*is*p*."</span>,</div><div class="line">		want: <span class="literal">false</span>,</div><div class="line">	&#125;,</div><div class="line">	<span class="comment">// 篇幅关系，只提供题目的例子</span></div><div class="line">	<span class="comment">// 实际开发一定要多考虑不同的测试用例</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test_isMatch</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</div><div class="line">		t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">			<span class="keyword">if</span> got := isMatch(tt.s, tt.p); got != tt.want &#123;</div><div class="line">				t.Errorf(<span class="string">"isMatch() = %v, want %v"</span>, got, tt.want)</div><div class="line">			&#125;</div><div class="line">		&#125;)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>篇幅关系，例子以外的测试用例，留给大家自己想。</p>
<p>刷题新手基础差，题目见得少，一开始没有思路是正常的。但将对题意的理解翻译成测试用例，还有根据题目约束列出边界条件，细心一点总是可以做到的。偶尔有理解盲区，也很正常，多练习就好。</p>
<p>以这道题为例，如果认真看题目给的约束，马上就能添加几个边界条件：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	name: <span class="string">"0v0"</span>,</div><div class="line">	s:    <span class="string">""</span>,</div><div class="line">	p:    <span class="string">""</span>,</div><div class="line">	want: <span class="literal">true</span>,</div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">	name: <span class="string">"0va"</span>,</div><div class="line">	s:    <span class="string">""</span>,</div><div class="line">	p:    <span class="string">"a"</span>,</div><div class="line">	want: <span class="literal">false</span>,</div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">	name: <span class="string">"0va*"</span>,</div><div class="line">	s:    <span class="string">""</span>,</div><div class="line">	p:    <span class="string">"a*"</span>,</div><div class="line">	want: <span class="literal">true</span>,</div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">	name: <span class="string">"av0"</span>,</div><div class="line">	s:    <span class="string">"a"</span>,</div><div class="line">	p:    <span class="string">""</span>,</div><div class="line">	want: <span class="literal">false</span>,</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h2 id="直接动手"><a href="#直接动手" class="headerlink" title="直接动手"></a>直接动手</h2><p>之前一直强调，先从简单粗暴的解法入手，再逐渐改进，比没有思路干耗强。如果是比赛，解决之后没有更好的思路，不妨提交看看，也许测试数据强度不高，又或者其实想多了没有更好的解法，直接就通过了。如果是面试，不能一步到位最优解，也不妨给出初步答案，重点展现改进的思路。如果是平时练习，可以逐渐打磨，积累自己的 SOP。</p>
<p>等题目见多了，找到窍门，可以一下子想几步，就没必要一步步跟着看，可以直接跳到后面部分，或者直接关闭文章走人。（我是认真的，如果你看到题目直接想到了 <strong>最优子结构</strong> 和 <strong>状态转移</strong> ，就没有必要停留。）</p>
<p>当然可能也会有人觉得，思路展开得还不够细。确实，限于篇幅，不太可能从最『耿直』的代码开始，每个小改进贴一次代码。中间跳过的部分，如果你觉得有必要，可以自己推算一下。</p>
<h3 id="分析题目"><a href="#分析题目" class="headerlink" title="分析题目"></a>分析题目</h3><p>我们很容易发现，难点是 <code>*</code> ，也就是那句『<strong>匹配 0 到 多个</strong>』，就是这句话让复杂度暴增。</p>
<p>如果把 <code>*</code> 去掉，只需要从头到尾逐个字符匹配，任意一个字符不匹配就可以直接返回 false。没有任何例外。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">isMatch</span><span class="params">(s <span class="keyword">string</span>, p <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) != <span class="built_in">len</span>(p) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> s &#123;</div><div class="line">		<span class="keyword">if</span> s[i] != p[i] &amp;&amp; p[i] != <span class="string">'.'</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一旦加入 <code>*</code> ，事情就变复杂了。举例 <code>abbbbbbba</code> 和 <code>abb*bba</code> ：</p>
<p><img src="../../images/leetcode10-sample1.svg" alt=""></p>
<p>假定 <code>*</code> 尽量少匹配字符（简称懒汉策略），从匹配 0 个字符开始（是的，不要忘了可以匹配 0 个字符），继续往下试，直到发现不匹配。这时不能像没有 <code>*</code> 时那样直接返回不匹配，而是要回到 <code>*</code> 之前匹配的位置，尝试让 <code>*</code> 多匹配一个字符，把剩下的再来一遍。不行？再来一遍。又不行？再来一遍……</p>
<p>直到</p>
<ul>
<li>哇，剩下的都匹配上了。true</li>
<li>噢，<code>b*</code> 遇到了 <code>b</code> 以外的字符。false</li>
</ul>
<h3 id="回溯法"><a href="#回溯法" class="headerlink" title="回溯法"></a>回溯法</h3><p>后面剩余的字符串每次都要再尝试匹配一遍，低效暂且不管。关键发现后面的不匹配，得回到 <code>b*</code> 匹配的位置。</p>
<p><code>b*</code> 的位置，还有在 s 里的匹配位置，记录的临时变量在后面继续匹配时被覆盖了？那不行，得存起来。</p>
<p>多给一套临时变量？那再来一个 <code>c*</code>  ,  <code>d*</code> , <code>e*</code> 怎么办？只能用栈！</p>
<p>这种搜索答案时遇到选择，<strong>把选择点存起来</strong> ，先选一个分支走下去，走不通时 <strong>回到选择点继续</strong> 的做法，叫 <strong>回溯法</strong> 。那个选择点，叫回溯点。以前上课，是这样帮助学员记忆的：『能进则进，不能进则换，不能换则退』。这里的 <strong>进</strong> ，指选一个分支往下走； <strong>换</strong> 指在回溯点换一个分支； <strong>退</strong> 指当前回溯点所有分支都走不通，退回上一个回溯点。</p>
<p>把理解翻译成代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 回溯法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">isMatch</span><span class="params">(s <span class="keyword">string</span>, p <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> isMatchBT(s, p, <span class="built_in">len</span>(s)<span class="number">-1</span>, <span class="built_in">len</span>(p)<span class="number">-1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// BT = BackTracking</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">isMatchBT</span><span class="params">(s <span class="keyword">string</span>, p <span class="keyword">string</span>, is <span class="keyword">int</span>, ip <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> &#123; <span class="comment">// 普通匹配循环</span></div><div class="line">		<span class="keyword">if</span> ip &lt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">if</span> is &lt; <span class="number">0</span> &#123; <span class="comment">// 两边同时结束，没有发现不匹配</span></div><div class="line">				<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// pattern 结束而 string 有剩余，不匹配</span></div><div class="line">			<span class="comment">// 反之 只有 is &lt; 0 需要进一步判断，因为剩余的 pattern 有可能匹配空串</span></div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> p[ip] == <span class="string">'*'</span> &#123; <span class="comment">// '*' 进入递归回溯，为避免嵌套太深，break 后另起 for 循环</span></div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 1. pattern 不是 '*'，而 string 还有剩余，不匹配</span></div><div class="line">		<span class="comment">// 2. 字符不匹配</span></div><div class="line">		<span class="keyword">if</span> is &lt; <span class="number">0</span> || (s[is] != p[ip] &amp;&amp; p[ip] != <span class="string">'.'</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">		is--</div><div class="line">		ip--</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ip--</div><div class="line">	<span class="keyword">for</span> &#123; <span class="comment">// '*' 回溯循环</span></div><div class="line">		<span class="keyword">if</span> isMatchBT(s, p, is, ip<span class="number">-1</span>) &#123; <span class="comment">// 递归匹配剩余串</span></div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 剩余串不匹配，'*' 尝试再匹配一个字符后递归</span></div><div class="line"></div><div class="line">		<span class="comment">// 1. string 结束，'*' 无法进一步匹配</span></div><div class="line">		<span class="comment">// 2. 字符不匹配</span></div><div class="line">		<span class="keyword">if</span> is &lt; <span class="number">0</span> || (s[is] != p[ip] &amp;&amp; p[ip] != <span class="string">'.'</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">		is--</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>回溯要用到栈，有两个选择：</p>
<ul>
<li><p>自己管理一个栈。遇到选择分支就将回溯点压栈，要回溯就弹栈。</p>
<p>  优点是避免了函数调用的开销，缺点是不直观容易绕晕。</p>
</li>
<li><p>直接递归，利用函数栈保留回溯点。调用下一层函数相当于压栈，返回一层相当于弹栈。</p>
<p>  优缺点刚好反过来。</p>
</li>
</ul>
<p>这里为了直观，选择了直接递归。注意控制局部变量的数量，调用函数的开销也没有想象中大。</p>
<p>其它要点：</p>
<ul>
<li>理论上，可以每匹配一个字符就递归一层，这样代码最简洁。但 <code>*</code> 以外的匹配并不复杂，沿用前面写的循环即可，仅仅遇到 <code>*</code> 才回溯，减少调用栈的深度。</li>
<li>从左到右匹配和从右到左，效率上没有什么差别，因为不匹配的部分在哪是随机的。但是从左到右总是要多读一个字符判断是否 <code>*</code> ，而从右到左可以在读到 <code>*</code> 时再多读一个字符组成匹配项。</li>
</ul>
<p>测试一下，通过。</p>
<h2 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h2><p>不过，如果你生成比较大、比较复杂的测试数据，会发现回溯法的用时特别多，轻易上到秒级别。</p>
<p>原因其实前面已经提到过了，那就是每次回溯，<strong>剩余的字符串都要再尝试匹配一遍</strong> 。</p>
<p>这里面有没有重复劳动？我们再来看一个例子 <code>abbbccccccca</code> 和 <code>ab*b*c*</code> ：</p>
<p><img src="../../images/leetcode10-sample2.svg" alt=""></p>
<p>前半段 <code>abbb</code> 和 <code>ab*b*</code> 有多种匹配方式。前面匹配之后，接着判断余下 <code>ccccccca</code> 和 <code>c*</code> 部分。</p>
<p>后面不匹配？可能前面匹配多了或者少了字符，换一种方式匹配后，又回到后半段。因为当前的代码没有记录，并不知道后半段的状态重复出现，又运算了一遍。这些运算量就浪费掉了。</p>
<p>如果能保存运算过的结果就好了。</p>
<h3 id="缓存子问题的解"><a href="#缓存子问题的解" class="headerlink" title="缓存子问题的解"></a>缓存子问题的解</h3><p>上次讲 <a href="../leetcode-4-median-of-two-sorted-arrays/">二分查找</a> 时，说到一个优化的思路：只获取 <strong>最小的必要信息</strong>，否则会为不需要的信息付出额外的运算。</p>
<p>那么这次是另一个很重要的思路： <strong>发现并消除重复运算</strong>。</p>
<p>具体到动态规划（Dynamic Planning，以下简称 DP），就是：</p>
<ol>
<li>定义子问题；</li>
<li>开辟额外空间，缓存子问题的最优解；</li>
<li>当引用重叠子问题（overlapping sub-problems）的解时，读取缓存，来避免重复运算。</li>
</ol>
<p>要应用 DP 有两个关键条件：</p>
<ul>
<li><p>存在重叠子问题。</p>
<p>  DP 本质上仍然是 “Brute-Force” 搜索答案，只是做了巧妙的去重。如果不存在重叠子问题，费劲缓存没有意义。</p>
</li>
<li><p>子问题有最优子结构。</p>
<p>  最优子结构（optimal substructure）是指，全局问题的最优解包含的子问题解，也是最优解。适合贪心算法的问题也有同样特性。</p>
<p>  区别在于，贪心算法能直接从局部最优推出全局最优，DP 则不一定。DP 的全局最优解，是部分子问题最优解的组合。不一定所有子问题的解都能用上，但用上的一定是最优解。</p>
<p>  这其实很好理解：缓存的就是子问题最优解， <strong>如果全局最优包含的不是最优解，缓存就没有意义</strong>。</p>
</li>
</ul>
<p>即使对同一个问题，这两个条件也不是固定不变的，是否成立有时依赖于如何定义子问题。要 <strong>恰当地定义和分割子问题</strong> ，满足这两个条件，将复杂问题逐渐分解成简单子问题，并缓存子问题的解。这需要 <strong>分治法</strong> 作为前置知识，篇幅所限，有机会再补坑。</p>
<p>回到题目，我们将子问题 $ DP_{is, ip} $ 定义为 <code>s[is:]</code> 与 <code>p[ip:]</code> 是否匹配（注：<code>s[is:]</code> 表示从下标 is 一直到结尾的子串，子串右下标缺省表示取到末尾），那么全局就是 $ DP_{0, 0} $ 。全局解和子问题解的递推关系为：</p>
<p>$$<br>\left\{<br>\begin{array}{lr}<br>DP_{is, ip} = match(s[is],p[ip]) \land DP_{is+1, ip+1} &amp; (p[ip+1]\ is\ not\ *) \\<br>DP_{is, ip} = DP_{is, ip+2} \lor (match(s[is],p[ip]) \land DP_{is+1, ip}) &amp; (p[ip+1]\ is\ *)<br>\end{array}<br>\right.<br>$$</p>
<p>翻译成大白话就是，当前子问题匹配，需要 1. 当前位置两边的字符匹配 且 2. 余下的子问题匹配。<code>*</code> 的特殊处理后面就着代码说。</p>
<p>重叠子问题上面已经给了例子。至于最优子结构，将字符串分割成不同部分进行匹配，需要每一部分都匹配，才能得出整体匹配。全局解，包含局部解。而子问题 $ DP_{is, ip} $ 匹配与否，只有唯一解，相当于最优解。</p>
<p>子问题的解称为状态，这种根据上一阶段的状态计算出当前状态的推导式，称之为 <strong>状态转移方程</strong> 。</p>
<p>有状态转移方程，就可以写代码了。这时又有两种选择：</p>
<ul>
<li><p>Top-down</p>
<p>  先尝试引用，如果发现解不存在，再去计算。计算时引用到的解如果不存在，再递归去计算。换言之， <strong>不用不算，用到再算</strong> 。</p>
<p>  优点是，<strong>没有被最终答案（直接或间接）引用的子问题，不会被计算</strong> 。缺点是，需要先自顶向下分解，然后到了最里层返回时计算，需要用到栈或者递归，有额外的内存和函数调用开销。</p>
<p>  这种方式又被称为 记忆化（Memorized）/ 备忘录（Memorization）方法。</p>
</li>
<li><p>Bottom-up</p>
<p>  或者不管用不用得上，从最小的子问题开始，构造相邻的状态，直到获得全局解为止。</p>
<p>  优缺点刚好反过来。</p>
</li>
</ul>
<h3 id="记忆化-Top-down"><a href="#记忆化-Top-down" class="headerlink" title="记忆化 Top-down"></a>记忆化 Top-down</h3><p>先看 Top-down 的代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DP: Top-down</span></div><div class="line"><span class="keyword">type</span> state <span class="keyword">uint8</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> ( <span class="comment">// 用到才计算，所以需要 true， false 以外的值表示 '未计算'</span></div><div class="line">	unknown state = <span class="literal">iota</span></div><div class="line">	unmatched</div><div class="line">	matched</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// memo[is][ip] 表示 s[is:] 与 p[ip:] 两个子串是否匹配</span></div><div class="line"><span class="keyword">var</span> memo [][]state</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">isMatch</span><span class="params">(s <span class="keyword">string</span>, p <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="comment">// 为了避免特殊判断，多出一行一列，用来处理空子串</span></div><div class="line">	memo = <span class="built_in">make</span>([][]state, <span class="built_in">len</span>(s)+<span class="number">1</span>)</div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> memo &#123;</div><div class="line">		memo[i] = <span class="built_in">make</span>([]state, <span class="built_in">len</span>(p)+<span class="number">1</span>)</div><div class="line">		memo[i][<span class="built_in">len</span>(p)] = unmatched <span class="comment">// pattern 为空子串一定不匹配</span></div><div class="line">	&#125;</div><div class="line">	memo[<span class="built_in">len</span>(s)][<span class="built_in">len</span>(p)] = matched <span class="comment">// 特例：两个子串都为空时匹配</span></div><div class="line">	<span class="keyword">return</span> isMatchMemo(s, p, <span class="number">0</span>, <span class="number">0</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">isMatchMemo</span><span class="params">(s <span class="keyword">string</span>, p <span class="keyword">string</span>, is <span class="keyword">int</span>, ip <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> memo[is][ip] == unknown &#123;</div><div class="line">		preMatch := is &lt; <span class="built_in">len</span>(s) &amp;&amp; (p[ip] == <span class="string">'.'</span> || s[is] == p[ip])</div><div class="line"></div><div class="line">		<span class="keyword">if</span> ip+<span class="number">1</span> &lt; <span class="built_in">len</span>(p) &amp;&amp; p[ip+<span class="number">1</span>] == <span class="string">'*'</span> &#123;</div><div class="line">			<span class="comment">// 匹配空串（消耗 pattern）</span></div><div class="line">			<span class="keyword">if</span> isMatchMemo(s, p, is, ip+<span class="number">2</span>) ||</div><div class="line">				<span class="comment">// 匹配一个字符（不消耗 pattern）</span></div><div class="line">				(preMatch &amp;&amp; isMatchMemo(s, p, is+<span class="number">1</span>, ip)) &#123;</div><div class="line">				memo[is][ip] = matched</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				memo[is][ip] = unmatched</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> preMatch &amp;&amp;</div><div class="line">				isMatchMemo(s, p, is+<span class="number">1</span>, ip+<span class="number">1</span>) &#123;</div><div class="line">				memo[is][ip] = matched</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				memo[is][ip] = unmatched</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> memo[is][ip] == matched</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>跟回溯法细节上的差异：</p>
<ul>
<li><p>回溯法为了避免不必要的递归和回溯，<code>*</code> 以外的匹配都是直接在循环内处理，没有必要调用函数。但这里每次都要 <strong>尽可能少匹配字符， 然后交给递归处理</strong> 。这样是为了子问题分割的 <strong>粒度尽可能小</strong>，让每个（被引用到的）子问题的解都有缓存。</p>
</li>
<li><p>为了达到第一点，<code>*</code> 的匹配分成两种：要么匹配 s 空串消耗 pattern，要么匹配 s 单个字符不消耗 pattern。<strong>不同时消耗 s 和 p 的字符</strong> 。这一条是主要的难点。（不消耗是指，虽然 <code>*</code> 匹配了字符，但是 p 串下标不移动，留在原地继续匹配 s 串下一个字符）</p>
<p>  以 <code>bbbb</code> 匹配 <code>b*</code> 为例，分了 5 步（不包括失败的尝试）：<code>b*</code> 匹配 4 次 <code>b</code> 都保留 <code>b*</code> ，然后第 5 次匹配 空串才消耗掉。</p>
</li>
<li><p>Top-down DP 分解和实际计算的方向是反的。从左到右递归引用子问题，计算时就是从右到左组合。实际写就会发现，从右到左引用，下标处理麻烦一些。（如果从右到左，子问题 $ DP_{is, ip} $ 就要定义成 <code>s[0:is]</code> 和 <code>s[0:ip]</code> 是否匹配。）</p>
</li>
</ul>
<h3 id="Bottom-up"><a href="#Bottom-up" class="headerlink" title="Bottom-up"></a>Bottom-up</h3><p>Bottom-up 的代码会简洁一些：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Bottom-up</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">isMatch</span><span class="params">(s <span class="keyword">string</span>, p <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	dp := <span class="built_in">make</span>([][]<span class="keyword">bool</span>, <span class="built_in">len</span>(s)+<span class="number">1</span>)</div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> dp &#123;</div><div class="line">		dp[i] = <span class="built_in">make</span>([]<span class="keyword">bool</span>, <span class="built_in">len</span>(p)+<span class="number">1</span>)</div><div class="line">	&#125;</div><div class="line">	dp[<span class="built_in">len</span>(s)][<span class="built_in">len</span>(p)] = <span class="literal">true</span></div><div class="line"></div><div class="line">	<span class="keyword">for</span> is := <span class="built_in">len</span>(s); is &gt;= <span class="number">0</span>; is-- &#123;</div><div class="line">		<span class="keyword">for</span> ip := <span class="built_in">len</span>(p) - <span class="number">1</span>; ip &gt;= <span class="number">0</span>; ip-- &#123;</div><div class="line">			preMatch := is &lt; <span class="built_in">len</span>(s) &amp;&amp; (p[ip] == <span class="string">'.'</span> || s[is] == p[ip])</div><div class="line">			<span class="keyword">if</span> ip+<span class="number">1</span> &lt; <span class="built_in">len</span>(p) &amp;&amp; p[ip+<span class="number">1</span>] == <span class="string">'*'</span> &#123;</div><div class="line">				dp[is][ip] = dp[is][ip+<span class="number">2</span>] ||</div><div class="line">					(preMatch &amp;&amp; dp[is+<span class="number">1</span>][ip])</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				dp[is][ip] = preMatch &amp;&amp; dp[is+<span class="number">1</span>][ip+<span class="number">1</span>]</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> dp[<span class="number">0</span>][<span class="number">0</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除了 p 子串为空时不用计算（即 ip 为 <code>len(p)</code> ，此时 <code>p[ip:]</code> 为空），Bottom-up 所有子问题都会算一遍（包括 s 子串为空也要实际判断，因为 p 有可能匹配空串）。没有必要区分是否已经计算，状态矩阵直接用 bool 值。</p>
<p>也因为这样，Bottom-up 对子问题的划分 <strong>不重不漏</strong> 的要求更严格一些。Top-down 里如果不小心一次匹配了多个字符，导致不是每个解都有缓存，出现重复计算，只是影响运行效率。而这里如果子问题分得不够细，跳过了某个子问题的计算，后续引用到的就可能是错误值。</p>
<h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><h3 id="运行速度"><a href="#运行速度" class="headerlink" title="运行速度"></a>运行速度</h3><p>三种解法都通过了单元测试。剩下就是要比较运行速度。在复杂度分析之前，可以直观地看一下基准测试（Benchmark Test）。</p>
<p>暂时没有发现自动生成基准测试代码的工具，还好手敲很简单：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_isMatch1</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		<span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</div><div class="line">			isMatch1(tt.s, tt.p)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_isMatch2</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		<span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</div><div class="line">			isMatch2(tt.s, tt.p)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_isMatch3</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		<span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</div><div class="line">			isMatch3(tt.s, tt.p)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>把三种实现依次重命名为 <code>isMatch1</code> 、 <code>isMatch2</code> 、 <code>isMatch3</code>，对应三个基准测试。先用题目自带的用例测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Benchmark_isMatch1-8   	 5172118	       224 ns/op	       0 B/op	       0 allocs/op</div><div class="line">Benchmark_isMatch2-8   	  599966	      1882 ns/op	    1024 B/op	      39 allocs/op</div><div class="line">Benchmark_isMatch3-8   	  545421	      2325 ns/op	    1024 B/op	      39 allocs/op</div><div class="line">PASS</div><div class="line">ok  	leetcode	4.621s</div></pre></td></tr></table></figure>
<p>（每列的含义依次为：测试名、循环次数、平均耗时、平均内存分配、平均内存分配次数，默认情况下测试时间为 1 秒。）</p>
<p>可以看到，在数据量小、用例简单时，DP 完全不占优势，回溯法快 10 倍左右。毕竟光初始化内存就落后了。</p>
<p>这时，将测试用例改为这两个：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">		name: <span class="string">"6"</span>,</div><div class="line">		s:    <span class="string">"a...省略197个a...ab"</span>,</div><div class="line">		p:    <span class="string">"caa*a*a*a*b*"</span>,</div><div class="line">		want: <span class="literal">false</span>,</div><div class="line">	&#125;,</div><div class="line">	&#123;</div><div class="line">		name: <span class="string">"7"</span>,</div><div class="line">		s:    <span class="string">"ca...省略197个a...a"</span>,</div><div class="line">		p:    <span class="string">"c*aa*a*a*a*b"</span>,</div><div class="line">		want: <span class="literal">false</span>,</div><div class="line">	&#125;,</div></pre></td></tr></table></figure>
<p>这两个特意构造的用例， s 串特别长，重复字符多，p 串 <code>*</code> 也多；最终结果是 false，让代码一直搜索到最后；不匹配的字符一个在最左一个在最右，抵消因为方向导致的优势。（最初准备的用例长度为 500，结果运行起来非常慢，才缩短为 200 。）看看结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Benchmark_isMatch1-8   	       2	 730041750 ns/op	       0 B/op	       0 allocs/op</div><div class="line">Benchmark_isMatch2-8   	   43952	     27281 ns/op	   16160 B/op	     404 allocs/op</div><div class="line">Benchmark_isMatch3-8   	   33331	     36155 ns/op	   16160 B/op	     404 allocs/op</div><div class="line">PASS</div><div class="line">ok  	leetcode	5.940s</div></pre></td></tr></table></figure>
<p>结果一下子就逆转了。DP 比回溯法快了 约 4 个数量级。而且很明显，如果继续加大测试强度，这个差距会继续放大。</p>
<p>两种 DP 的对比， Top-down 的速度又要比 Bottom-up 快了约 30% 。跳过引用不到的子问题，起了作用。</p>
<h3 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h3><p>接下来看一下复杂度。以下假设字符串 s 的大小为 S，p 的大小为 P。</p>
<h4 id="动态规划-1"><a href="#动态规划-1" class="headerlink" title="动态规划"></a>动态规划</h4><p>DP 的复杂度很好算。$ DP_{is, ip} $ 一共有 SP 个组合，也就是有这么多个子问题。对于每个子问题，需要判断当前下标指向的字符是否匹配，然后引用相邻子问题，每个子问题需要常数时间。换言之整体的时间复杂度就是 $ O(SP) $ 。</p>
<p>相应地，额外内存主要是缓存子问题解的二维数组，空间复杂度也是 $ O(SP) $ 。</p>
<p>Top-down 记忆化根据不同数据，可能会跳过部分子问题，但没有改变复杂度阶。</p>
<h4 id="回溯法-1"><a href="#回溯法-1" class="headerlink" title="回溯法"></a>回溯法</h4><p>回溯法的复杂度计算复杂一些。如果没有 <code>*</code> ，那么时间复杂度只是 $ O(S) $。加入 <code>*</code> 是复杂度的主要来源。参考基准测试的两个例子，构建类似 <code>aaaaaaaaac</code> 和 <code>.*.*.*b</code> 这样的最坏情况，p 串里都是 <code>.*</code> ，最后一个字符总是匹配失败无法提前退出。</p>
<p>考虑 递归函数 <code>isMatchBT</code> 的调用次数。对 <code>isMatchBT(s, p, is, ip)</code>，ip 点左边一共有 $ ip / 2 $ 个 <code>.*</code> ，匹配的过程相当于把 $ is $ 个元素分成 $ ip/2 $ 组，也就是在 $ is + 1 $ 个点里选取 $ ip / 2-1 $ 个点分割，数量为 $ \mathrm{C}_{is + 1}^{ip / 2-1} $ 。</p>
<p>对于一次函数调用，调用之前在 s 串匹配一个字符，然后调用函数，不考虑进入函数之后的开销，需要常数时间。进入函数后分两种情况：一是普通字符串的匹配，二是递归调用函数。考虑最坏的情况，都是 <code>*</code> 产生的递归调用，函数内部的开销在统计其他函数调用时计算。换言之，总的递归函数调用次数就是总的复杂度。</p>
<p>$$ \sum_{is=0}^S \sum_{ip=0}^{P/2} \mathrm{C}_{is + 1}^{ip / 2-1} $$</p>
<p>太久不看数学，已经不记得怎么算这种式子了。时间关系，只好以后再计算和验证了。</p>
<p>空间开销主要在函数调用栈上，每次函数调用使用常数内存，如果不考虑内存释放，那么空间复杂度和时间复杂度一致。但实际上，函数返回栈上的空间就释放了，空间复杂度跟最大调用深度相关，也就是 $ O(P) $ 。</p>
<p><br></p>
<p>把最快的 Top-down DP 提交，时间： 0 ms，打败 100% 的提交；内存：2.4 MB，打败45.05% 。这道题的测试数据很弱，其实回溯也是可以过的，就是比较慢。</p>
<hr>
<p>更新：</p>
<p>我实际做题时用的是 Top-down，其余代码都是为了写文章额外写的，所以没有太注意优化。</p>
<p>公众号发出之后，有朋友提醒，Bottom-up 只引用到最近的两排状态，空间复杂度可以优化到 $ O(P) $ 。</p>
<p>确实如此，优化之后，综合时间和空间复杂度，Bottom-up 才是最佳解法。Top-down 快 30% 毕竟是在极端 case 测得，一般快不了这么多。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">isMatch</span><span class="params">(s <span class="keyword">string</span>, p <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(p) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="built_in">len</span>(s) == <span class="number">0</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	lastDp := <span class="built_in">make</span>([]<span class="keyword">bool</span>, <span class="built_in">len</span>(p)+<span class="number">1</span>)</div><div class="line">	curDp := <span class="built_in">make</span>([]<span class="keyword">bool</span>, <span class="built_in">len</span>(p)+<span class="number">1</span>)</div><div class="line">	<span class="keyword">for</span> is := <span class="built_in">len</span>(s); is &gt;= <span class="number">0</span>; is-- &#123;</div><div class="line">		<span class="keyword">for</span> ip := <span class="built_in">len</span>(p) - <span class="number">1</span>; ip &gt;= <span class="number">0</span>; ip-- &#123;</div><div class="line">			preMatch := is &lt; <span class="built_in">len</span>(s) &amp;&amp; (p[ip] == <span class="string">'.'</span> || s[is] == p[ip])</div><div class="line">			<span class="keyword">if</span> ip+<span class="number">1</span> &lt; <span class="built_in">len</span>(p) &amp;&amp; p[ip+<span class="number">1</span>] == <span class="string">'*'</span> &#123;</div><div class="line">				curDp[ip] = curDp[ip+<span class="number">2</span>] ||</div><div class="line">					(preMatch &amp;&amp; lastDp[ip]) || </div><div class="line">					(is == <span class="built_in">len</span>(s) &amp;&amp; ip+<span class="number">2</span> == <span class="built_in">len</span>(p))</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				curDp[ip] = preMatch &amp;&amp;</div><div class="line">					(lastDp[ip+<span class="number">1</span>] ||</div><div class="line">					 (is+<span class="number">1</span> == <span class="built_in">len</span>(s) &amp;&amp; ip+<span class="number">1</span> == <span class="built_in">len</span>(p)))</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		lastDp, curDp = curDp, lastDp</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> lastDp[<span class="number">0</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用同样的数据再跑一次 Benchmark，不仅内存用少了，还比 Top-down 还要快。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Benchmark_isMatch1-8    	       2	 681538950 ns/op	       0 B/op	       0 allocs/op</div><div class="line">Benchmark_isMatch2-8       	   43952	     27259 ns/op	   16160 B/op	     404 allocs/op</div><div class="line">Benchmark_isMatch3-8    	   32874	     36262 ns/op	   16160 B/op	     404 allocs/op</div><div class="line">Benchmark_isMatch4-8   	       48579	     24745 ns/op	      64 B/op	       4 allocs/op</div><div class="line">PASS</div></pre></td></tr></table></figure>
<hr>
<p><img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="知识共享 “署名-非商业性使用-相同方式共享” 4.0 (CC BY-NC-SA 4.0)”许可协议"><br>本文为本人原创，采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="external">知识共享 “署名-非商业性使用-相同方式共享” 4.0 (CC BY-NC-SA 4.0)”许可协议</a>进行许可。<br>本作品可自由复制、传播及基于本作品进行演绎创作。如有以上需要，请留言告知，在文章开头明显位置加上署名（Jayce Chant）、原链接及许可协议信息，并明确指出修改（如有），不得用于商业用途。谢谢合作。<br>请点击查看<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="external">协议</a>的中文摘要。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://jaycechant.info/2020/leetcode-10-regular-expression-matching/" data-id="ckor1vxxf00329kxlk01hjtth" class="article-share-link" data-share="baidu">分享到</a>
      

      
        <a href="https://jaycechant.info/2020/leetcode-10-regular-expression-matching/#disqus_thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Algorithm/">Algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LeetCode/">LeetCode</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/the-nine-tones-and-six-tunes-of-cantonese/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">
        
          粤语（广州话）的九声六调
        
      </div>
    </a>
  
  
    <a href="/2020/rapidly-generate-unit-tests-in-vs-code/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">在 VS Code 快速生成单元测试</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>
</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go-语言实战/">Go 语言实战</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/刷题/">刷题</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/科普/">科普</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/粤语/">粤语</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Algorithm/" style="font-size: 13.33px;">Algorithm</a> <a href="/tags/Anaconda/" style="font-size: 10px;">Anaconda</a> <a href="/tags/Android/" style="font-size: 11.67px;">Android</a> <a href="/tags/Android-sdk/" style="font-size: 10px;">Android-sdk</a> <a href="/tags/CentOS/" style="font-size: 10px;">CentOS</a> <a href="/tags/DNS/" style="font-size: 10px;">DNS</a> <a href="/tags/JCE/" style="font-size: 10px;">JCE</a> <a href="/tags/Java/" style="font-size: 11.67px;">Java</a> <a href="/tags/JavaMail/" style="font-size: 10px;">JavaMail</a> <a href="/tags/Jenkins/" style="font-size: 16.67px;">Jenkins</a> <a href="/tags/LeetCode/" style="font-size: 15px;">LeetCode</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Markdown/" style="font-size: 13.33px;">Markdown</a> <a href="/tags/Mathjax/" style="font-size: 10px;">Mathjax</a> <a href="/tags/OJ/" style="font-size: 10px;">OJ</a> <a href="/tags/Octopress/" style="font-size: 10px;">Octopress</a> <a href="/tags/OpenGrok/" style="font-size: 10px;">OpenGrok</a> <a href="/tags/Python/" style="font-size: 16.67px;">Python</a> <a href="/tags/Ruby/" style="font-size: 10px;">Ruby</a> <a href="/tags/Syncthing/" style="font-size: 10px;">Syncthing</a> <a href="/tags/TDD/" style="font-size: 10px;">TDD</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/Ubuntu/" style="font-size: 11.67px;">Ubuntu</a> <a href="/tags/algorithm/" style="font-size: 11.67px;">algorithm</a> <a href="/tags/aliyun/" style="font-size: 10px;">aliyun</a> <a href="/tags/app/" style="font-size: 10px;">app</a> <a href="/tags/blog/" style="font-size: 13.33px;">blog</a> <a href="/tags/byobu/" style="font-size: 11.67px;">byobu</a> <a href="/tags/ctags/" style="font-size: 10px;">ctags</a> <a href="/tags/dep/" style="font-size: 11.67px;">dep</a> <a href="/tags/document/" style="font-size: 10px;">document</a> <a href="/tags/dropbox/" style="font-size: 10px;">dropbox</a> <a href="/tags/file-system/" style="font-size: 10px;">file-system</a> <a href="/tags/flutter/" style="font-size: 10px;">flutter</a> <a href="/tags/git/" style="font-size: 11.67px;">git</a> <a href="/tags/glide/" style="font-size: 10px;">glide</a> <a href="/tags/golang/" style="font-size: 20px;">golang</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/how-to/" style="font-size: 16.67px;">how-to</a> <a href="/tags/jpg/" style="font-size: 10px;">jpg</a> <a href="/tags/json/" style="font-size: 11.67px;">json</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/mirror/" style="font-size: 10px;">mirror</a> <a href="/tags/netdisk/" style="font-size: 10px;">netdisk</a> <a href="/tags/node-js/" style="font-size: 11.67px;">node.js</a> <a href="/tags/nodePPT/" style="font-size: 11.67px;">nodePPT</a> <a href="/tags/npm/" style="font-size: 10px;">npm</a> <a href="/tags/pgyer/" style="font-size: 10px;">pgyer</a> <a href="/tags/pip/" style="font-size: 15px;">pip</a> <a href="/tags/png/" style="font-size: 10px;">png</a> <a href="/tags/practice/" style="font-size: 11.67px;">practice</a> <a href="/tags/presentation/" style="font-size: 11.67px;">presentation</a> <a href="/tags/review/" style="font-size: 10px;">review</a> <a href="/tags/screen/" style="font-size: 11.67px;">screen</a> <a href="/tags/service/" style="font-size: 10px;">service</a> <a href="/tags/skill/" style="font-size: 13.33px;">skill</a> <a href="/tags/smtp/" style="font-size: 10px;">smtp</a> <a href="/tags/software/" style="font-size: 10px;">software</a> <a href="/tags/solution-report/" style="font-size: 10px;">solution-report</a> <a href="/tags/supervisor/" style="font-size: 10px;">supervisor</a> <a href="/tags/thought/" style="font-size: 10px;">thought</a> <a href="/tags/trouble/" style="font-size: 18.33px;">trouble</a> <a href="/tags/unfinished/" style="font-size: 13.33px;">unfinished</a> <a href="/tags/virtualenv/" style="font-size: 10px;">virtualenv</a> <a href="/tags/vsftp/" style="font-size: 10px;">vsftp</a> <a href="/tags/why/" style="font-size: 11.67px;">why</a> <a href="/tags/写作/" style="font-size: 13.33px;">写作</a> <a href="/tags/动态规划/" style="font-size: 10px;">动态规划</a> <a href="/tags/安全/" style="font-size: 10px;">安全</a> <a href="/tags/数据结构/" style="font-size: 10px;">数据结构</a> <a href="/tags/翻译/" style="font-size: 13.33px;">翻译</a> <a href="/tags/语言表达/" style="font-size: 10px;">语言表达</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">四月 2012</a><span class="archive-list-count">5</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/golang-in-action-day-9-pointer-reference-and-value/">Go 语言实战（9）：指针、引用和值</a>
          </li>
        
          <li>
            <a href="/2021/pineapple-with-caramel-flavor/">18 公斤菠萝怎么吃？来个焦糖风味吧</a>
          </li>
        
          <li>
            <a href="/2021/golang-format-verbs/">Go 语言格式化动词</a>
          </li>
        
          <li>
            <a href="/2021/time-is-up/">现在写，可能都来不及了...</a>
          </li>
        
          <li>
            <a href="/2020/golang-in-action-day-8/">Go 语言实战（8）：命令行（3）CLI 框架</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="https://hexo.io/zh-cn/" target="_blank">Hexo主页</a>
          </li>
        
          <li>
            <a href="https://hexo.io/zh-cn/docs/" target="_blank">Hexo文档</a>
          </li>
        
          <li>
            <a href="https://github.com/xiangming/landscape-plus" target="_blank">landscape-plus项目主页</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Jayce Sigit Chant<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/list" class="mobile-nav-link">List</a>
  
    <a href="https://github.com/JayceChant" class="mobile-nav-link">Github</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
    <a href="/sitemap.xml" class="mobile-nav-link">Sitemap</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="返回顶部"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<script>
  var disqus_shortname = 'jaycetb';
  
  var disqus_url = 'https://jaycechant.info/2020/leetcode-10-regular-expression-matching/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>window._bd_share_config={"common":{},"share":{"bdCustomStyle":"/css/bdshare.css"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>



<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
                processEscapes: true
                    
}
  
        });
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
                  
}
    
        });
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Queue(function() {
            var all = MathJax.Hub.getAllJax(), i;
            for(i=0; i < all.length; i += 1) {
                            all[i].SourceElement().parentNode.className += ' has-jax';
                                    
            }
                
        });
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<script src="/js/script.js"></script>

</div>
</body>
</html>
